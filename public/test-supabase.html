<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase - CutBurn</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #2563eb; }
        .log { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Supabase - CutBurn</h1>
        <p>Usa questa pagina per testare la connessione a Supabase su Vercel.</p>
        
        <div>
            <h3>üìã Test Database</h3>
            <button onclick="testConnection()">Test Connessione</button>
            <button onclick="testTables()">Test Tabelle</button>
            <button onclick="clearLog()">Pulisci Log</button>
        </div>

        <div>
            <h3>üë§ Test Autenticazione</h3>
            <input type="email" id="testEmail" placeholder="Email test" value="test@cutburn.com">
            <input type="password" id="testPassword" placeholder="Password test" value="test123456">
            <input type="text" id="testName" placeholder="Nome test" value="Test User">
            <br>
            <button onclick="testSignUp()">Test Registrazione</button>
            <button onclick="testSignIn()">Test Login</button>
            <button onclick="testSignOut()">Test Logout</button>
        </div>

        <div id="log" class="log">üìù Log dei test apparir√† qui...\n</div>
    </div>

    <script>
        // Configurazione Supabase
        const supabaseUrl = 'https://tpajqgopbyyflomvkmly.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwYWpxZ29wYnl5ZmxvbXZrbWx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1MTU0NDQsImV4cCI6MjA2NjA5MTQ0NH0.s2SBDWqwNIWgu1u7n9AtiLgIyuTn0SjTfRYx7htzGOI';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'üìù Log pulito...\n';
        }

        async function testConnection() {
            log('üîÑ Testando connessione a Supabase...');
            try {
                const { data, error } = await supabase.from('user_profiles').select('count', { count: 'exact' });
                if (error) {
                    log(`‚ùå Errore connessione: ${error.message}`, 'error');
                    if (error.code === 'PGRST116') {
                        log('üí° Tabella user_profiles non esiste. Devi eseguire l\'SQL su Supabase!', 'error');
                    }
                } else {
                    log(`‚úÖ Connessione OK! Trovati ${data.length} record in user_profiles`, 'success');
                }
            } catch (err) {
                log(`‚ùå Errore generale: ${err.message}`, 'error');
            }
        }

        async function testTables() {
            log('üîÑ Testando struttura tabelle...');
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    log(`‚ùå Errore tabelle: ${error.message}`, 'error');
                } else {
                    log('‚úÖ Tabella user_profiles esiste e funziona!', 'success');
                    log(`üìä Struttura: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (err) {
                log(`‚ùå Errore test tabelle: ${err.message}`, 'error');
            }
        }

        async function testSignUp() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const name = document.getElementById('testName').value;

            log(`üîÑ Testando registrazione per: ${email}`);
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { name, full_name: name }
                    }
                });

                if (error) {
                    log(`‚ùå Errore registrazione: ${error.message}`, 'error');
                } else if (data.user && data.session) {
                    log('‚úÖ Registrazione completata con sessione!', 'success');
                    log(`üë§ Utente: ${JSON.stringify(data.user, null, 2)}`);
                    
                    // Prova a creare il profilo
                    await createUserProfile(data.user, name);
                } else if (data.user && !data.session) {
                    log('üìß Registrazione OK ma richiede conferma email', 'info');
                } else {
                    log('‚ö†Ô∏è Registrazione fallita senza errore specifico', 'error');
                }
            } catch (err) {
                log(`‚ùå Errore generale registrazione: ${err.message}`, 'error');
            }
        }

        async function createUserProfile(user, name) {
            log('üîÑ Creando profilo utente...');
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .insert({
                        auth_user_id: user.id,
                        name: name,
                        age: 25,
                        height: 170,
                        current_weight: 70,
                        start_weight: 70,
                        target_weight: 65,
                        activity_level: 'moderate',
                        goal: 'fat-loss',
                        target_calories: 1800,
                        target_water: 2500
                    })
                    .select()
                    .single();

                if (error) {
                    log(`‚ùå Errore creazione profilo: ${error.message}`, 'error');
                } else {
                    log('‚úÖ Profilo creato con successo!', 'success');
                    log(`üìã Profilo: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (err) {
                log(`‚ùå Errore generale creazione profilo: ${err.message}`, 'error');
            }
        }

        async function testSignIn() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            log(`üîÑ Testando login per: ${email}`);
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    log(`‚ùå Errore login: ${error.message}`, 'error');
                } else if (data.user && data.session) {
                    log('‚úÖ Login completato!', 'success');
                    log(`üë§ Utente: ${JSON.stringify(data.user, null, 2)}`);
                } else {
                    log('‚ö†Ô∏è Login fallito senza errore specifico', 'error');
                }
            } catch (err) {
                log(`‚ùå Errore generale login: ${err.message}`, 'error');
            }
        }

        async function testSignOut() {
            log('üîÑ Testando logout...');
            try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    log(`‚ùå Errore logout: ${error.message}`, 'error');
                } else {
                    log('‚úÖ Logout completato!', 'success');
                }
            } catch (err) {
                log(`‚ùå Errore generale logout: ${err.message}`, 'error');
            }
        }

        // Test iniziale automatico
        window.onload = function() {
            log('üöÄ Pagina caricata. Clicca "Test Connessione" per iniziare!');
        };
    </script>
</body>
</html> 